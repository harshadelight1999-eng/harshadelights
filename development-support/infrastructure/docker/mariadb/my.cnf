# =====================================================================================
# HARSHA DELIGHTS MARIADB CONFIGURATION
# =====================================================================================
# Production-ready MariaDB configuration optimized for ERPNext and EspoCRM
# =====================================================================================

[mysqld]
# -----------------------------------------------------------------------------
# BASIC SETTINGS
# -----------------------------------------------------------------------------

# Server settings
bind-address = 0.0.0.0
port = 3306
datadir = /var/lib/mysql
socket = /var/run/mysqld/mysqld.sock
pid-file = /var/run/mysqld/mysqld.pid

# Character set and collation
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
init-connect = 'SET NAMES utf8mb4'

# SQL Mode (strict mode for data integrity)
sql_mode = STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION

# Time zone
default-time-zone = '+00:00'

# -----------------------------------------------------------------------------
# CONNECTION SETTINGS
# -----------------------------------------------------------------------------

# Connection limits
max_connections = 200
max_user_connections = 150
max_connect_errors = 1000000

# Connection timeouts
connect_timeout = 10
wait_timeout = 28800
interactive_timeout = 28800

# Thread settings
thread_cache_size = 50
thread_handling = pool-of-threads
thread_pool_size = 4

# -----------------------------------------------------------------------------
# MEMORY SETTINGS
# -----------------------------------------------------------------------------

# Buffer pool (most important setting - adjust based on available RAM)
innodb_buffer_pool_size = 512M
innodb_buffer_pool_instances = 1

# Query cache
query_cache_type = 1
query_cache_size = 128M
query_cache_limit = 8M

# Table settings
table_open_cache = 4000
table_definition_cache = 1000

# Sort and join buffers
sort_buffer_size = 2M
join_buffer_size = 2M
read_buffer_size = 2M
read_rnd_buffer_size = 4M

# Temporary tables
tmp_table_size = 64M
max_heap_table_size = 64M

# Thread buffers
thread_stack = 256K

# -----------------------------------------------------------------------------
# INNODB SETTINGS
# -----------------------------------------------------------------------------

# InnoDB storage engine
default_storage_engine = InnoDB

# InnoDB file settings
innodb_file_per_table = 1
innodb_file_format = Barracuda
innodb_large_prefix = 1

# InnoDB log settings
innodb_log_file_size = 128M
innodb_log_files_in_group = 2
innodb_log_buffer_size = 16M

# InnoDB flush settings
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT

# InnoDB I/O settings
innodb_io_capacity = 200
innodb_io_capacity_max = 400
innodb_read_io_threads = 4
innodb_write_io_threads = 4

# InnoDB locking
innodb_lock_wait_timeout = 50
innodb_deadlock_detect = ON

# InnoDB purge settings
innodb_purge_threads = 1

# -----------------------------------------------------------------------------
# BINARY LOGGING AND REPLICATION
# -----------------------------------------------------------------------------

# Binary logging (required for replication and point-in-time recovery)
log-bin = mysql-bin
binlog_format = ROW
binlog_row_image = FULL
expire_logs_days = 7
max_binlog_size = 100M

# Server ID (unique for replication)
server-id = 1

# GTID (Global Transaction ID)
gtid_domain_id = 1

# -----------------------------------------------------------------------------
# LOGGING
# -----------------------------------------------------------------------------

# General query log (disable in production)
general_log = 0
general_log_file = /var/log/mysql/general.log

# Error log
log_error = /var/log/mysql/error.log
log_warnings = 2

# Slow query log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
log_queries_not_using_indexes = 1
log_slow_admin_statements = 1

# Binary log
log_bin_trust_function_creators = 1

# -----------------------------------------------------------------------------
# PERFORMANCE SCHEMA
# -----------------------------------------------------------------------------

# Performance schema (for monitoring)
performance_schema = ON
performance-schema-instrument = 'stage/%=ON'
performance-schema-instrument = 'statement/%=ON'
performance-schema-instrument = 'transaction=ON'

# -----------------------------------------------------------------------------
# SECURITY SETTINGS
# -----------------------------------------------------------------------------

# Disable symbolic links for security
symbolic-links = 0

# Skip external locking
skip-external-locking

# Local infile (disable for security)
local-infile = 0

# Secure auth
secure_auth = 1

# Skip name resolve (performance and security)
skip-name-resolve

# -----------------------------------------------------------------------------
# ERPNEXT SPECIFIC OPTIMIZATIONS
# -----------------------------------------------------------------------------

# ERPNext typically uses large transactions
max_allowed_packet = 256M

# For bulk operations
bulk_insert_buffer_size = 64M

# MyISAM settings (for temporary tables)
key_buffer_size = 64M
myisam_sort_buffer_size = 64M
myisam_max_sort_file_size = 10G

# -----------------------------------------------------------------------------
# ESPOCRM SPECIFIC OPTIMIZATIONS
# -----------------------------------------------------------------------------

# Group concat max length (for complex queries)
group_concat_max_len = 32768

# -----------------------------------------------------------------------------
# CLIENT SETTINGS
# -----------------------------------------------------------------------------

[mysql]
default-character-set = utf8mb4

[mysqldump]
default-character-set = utf8mb4
quick
quote-names
max_allowed_packet = 256M

[client]
default-character-set = utf8mb4
port = 3306
socket = /var/run/mysqld/mysqld.sock

# -----------------------------------------------------------------------------
# MYSQLD_SAFE SETTINGS
# -----------------------------------------------------------------------------

[mysqld_safe]
socket = /var/run/mysqld/mysqld.sock
nice = 0

# -----------------------------------------------------------------------------
# REPLICATION SETTINGS (FOR FUTURE SCALING)
# -----------------------------------------------------------------------------

# Master settings
#auto_increment_increment = 2
#auto_increment_offset = 1

# Slave settings
#read_only = 1
#relay_log = relay-bin
#relay_log_index = relay-bin.index

# -----------------------------------------------------------------------------
# BACKUP SETTINGS
# -----------------------------------------------------------------------------

# For consistent backups
innodb_max_dirty_pages_pct = 75